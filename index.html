<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMA* BST Route Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="sidebar">
        <h3>Select Start and Goal Nodes</h3>
        <label for="startNode">Start Node:</label>
        <select id="startNode">
            <!-- Dynamically populated options will be added here -->
        </select>
        <label for="goalNode">Goal Node:</label>
        <select id="goalNode">
            <!-- Dynamically populated options will be added here -->
        </select>
        <button onclick="findPath()">Find Path</button>

        <div class="node-info" id="nodeInfo">
            Rute Terpendek:
        </div>
    </div>

    <div id="mapid"></div>

    <script>
        // Function to create markers
        function createMarker(latlng, label) {
            return L.marker(latlng).bindPopup(label);
        }

        var map = L.map('mapid').setView([-7.55, 110.82], 13); // Centered on Surakarta

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var pathLayer = null; // To store the current path layer

        var dataGraph = {};

        // Load data from JSON file
        $(document).ready(function () {
            $.ajax({
                url: 'data.json',
                dataType: 'json',
                success: function (data) {
                    dataGraph = data; // Assign JSON data to dataGraph
                    populateDropdowns(); // Populate dropdowns after loading JSON
                    addNodeMarkers(); // Add markers after loading JSON
                    addEventListeners(); // Add event listeners for dropdowns
                    visualizeShortestPaths(null);
                }
            })
        })

        // Define graph nodes and edges
        var Graph_nodes = {
            'A': [['B', 2]], // Bandara Adi Sumarmo 
            'B': [['A', 2], ['C', 3], ['L', 4], ['R', 5], ['AM', 6]], // SMK Adi Sumarmo
            'C': [['B', 3], ['D', 4]], // SMA Assalaam Sukoharjo 
            'D': [['C', 4], ['E', 3], ['J', 1], ['K', 5], ['M', 6], ['N', 7], ['T', 8], ['U', 9], ['O', 10], ['AG', 11], ['AC', 12], ['Y', 13]], // SMA Batik 1 Surakarta 
            'E': [['D', 3], ['F', 2]], // SMA Al Islam 1 Surakarta 
            'F': [['E', 2], ['G', 2]], // SMK Negeri 8 Surakarta 
            'G': [['F', 2], ['H', 3], ['O', 3], ['X', 4], ['Q', 5]], // SMA Muhammadiyah 3 Surakarta 
            'H': [['G', 3], ['I', 4], ['AP', 5], ['AQ', 6]], // Universitas Sebelas Maret 
            'I': [['J', 2], ['AQ', 4]], // Terminal Palur 
            'J': [['D', 1]], // Sub Terminal Kerten
            'K': [['D', 5], ['L', 2]], // SMK Warga
            'L': [['K', 4], ['B', 4], ['M', 2], ['AN', 3], ['AG', 4]], // Sekolah Tinggi Pariwisata Sahid 
            'M': [['L', 2], ['D', 3], ['AN', 1], ['AO', 2], ['AP', 3], ['AF', 4], ['Z', 5]], // SMK Negeri 6 Surakarta
            'N': [['D', 3], ['O', 1]], // Victoria Hotel School
            'O': [['N', 1], ['P', 2], ['D', 3], ['W', 3], ['AD', 4]], // SMA Muhammadiyah 2 Surakarta 
            'P': [['O', 2], ['Q', 3], ['Z', 2], ['AT', 3]], // SMA 17 
            'Q': [['P', 3], ['R', 2]], // SMA Negeri 1 Surakarta
            'R': [['S', 2], ['B', 2]], // Terminal Kartosuro 
            'S': [['R', 2], ['T', 2]], // SMA Negeri 1 Kartasura
            'T': [['S', 3], ['U', 2]], // Jl. Raya Solo Yogyakarta
            'U': [['D', 2], ['V', 2]], // SMA Al-Muayyad Surakarta 
            'V': [['U', 2], ['W', 2]], // SMA Negeri 7 Surakarta 
            'W': [['V', 2], ['O', 3], ['AH', 2], ['Y', 3]], // MA Al-Islam Jamsaren Surakarta 
            'X': [['G', 3]], // Tugu Cembengan
            'Y': [['D', 2], ['W', 3]], // SMA Kristen 1 Surakarta
            'Z': [['M', 2], ['P', 2]], // JL Letjen S.Parman 
            'AA': [['AB', 2], ['AT', 1]], // Akademi Seni Mangkunegaran Surakarta 
            'AB': [['AA', 2], ['AC', 1]], // JL Ronggowarsito
            'AC': [['AB', 1], ['D', 2]], // JL Diponegoro 
            'AD': [['O', 2], ['AE', 3]], // JL Ir Soekarno 
            'AE': [['AD', 3]], // Solo Baru
            'AF': [['B', 3], ['M', 2]], // JL Letjen. Suprapto
            'AG': [['L', 2], ['D', 3]], // JL Dr Moewardi 
            'AH': [['W', 3], ['AJ', 4], ['AI', 3]], // SMA Majlis Tafsir Al Qur'an Surakarta 
            'AI': [['AH', 4]], // Sub Terminal Semanggi 
            'AJ': [['AH', 3], ['AR', 2]], // Pasar Bekonang
            'AM': [['B', 2]], // colomadu
            'AN': [['L', 3], ['M', 2]], // SMA N 4 Surakarta
            'AO': [['M', 3]], // Terminal tirtonadi
            'AP': [['M', 3], ['H', 3]], // SMK PGRI 2 Surakarta
            'AQ': [['H', 3], ['I', 3]], // Jl.KH.Maswi
            'AR': [['AJ', 2], ['AR', 3]], // SMA Negeri 1 Mojolaban
            'AS': [['AR', 3]], // Bekonang
            'AT': [['P', 3], ['AA', 1]], // SMA 1 Muhammadiyah Surakarta

        };


        // Define heuristic function
        function heuristic(n) {
            // Sample heuristic function (replace with actual if needed)
            var H_dist = {
                'A': 10,
                'B': 10,
                'C': 10,
                'D': 10,
                'E': 10,
                'F': 10,
                'G': 10,
                'H': 10,
                'I': 10,
                'J': 10,
                'K': 10,
                'L': 10,
                'M': 10,
                'N': 10,
                'O': 10,
                'P': 10,
                'Q': 10,
                'R': 10,
                'S': 10,
                'T': 10,
                'U': 10,
                'V': 10,
                'W': 10,
                'X': 10,
                'Y': 10,
                'Z': 10,
                'AA': 10,
                'AB': 10,
                'AC': 10,
                'AD': 10,
                'AE': 10,
                'AF': 10,
                'AG': 10,
                'AH': 10,
                'AI': 10,
                'AJ': 10,
                'AM': 10,
                'AN': 10,
                'AO': 10,
                'AP': 10,
                'AQ': 10,
                'AR': 10,
                'AS': 10,
                'AT': 10
            };
            return H_dist[n];
        }


        // Function to find the shortest path using SMA*
        function sma_star(start, goal, max_depth = 1000) {
            var open_set = [{ name: start, g: 0, h: heuristic(start), f: heuristic(start), parent: null }];
            var closed_set = new Set();
            var max_open_size = 30; // Limit size of open set

            while (open_set.length > 0) {
                open_set.sort((a, b) => a.f - b.f);
                var current = open_set.shift();

                if (current.name === goal) {
                    return backtrackPath(current);
                }

                if (closed_set.has(current.name)) {
                    continue;
                }

                if (!Graph_nodes[current.name]) {
                    return null;
                }

                closed_set.add(current.name);

                for (var [neighbor, weight] of Graph_nodes[current.name]) {
                    var g = current.g + weight;
                    var h = heuristic(neighbor);
                    var f = g + h;

                    var neighbor_node = { name: neighbor, g: g, h: h, f: f, parent: current };

                    if (open_set.length >= max_open_size) {
                        open_set.sort((a, b) => b.f - a.f);
                        open_set.pop();
                    }

                    open_set.push(neighbor_node);
                }

                if (closed_set.size > max_depth) {
                    console.log("Exceeded maximum depth, terminating.");
                    return null;
                }
            }


            console.log("Path does not exist!");
            return null;
        }

        // Function to backtrack the path from goal to start
        function backtrackPath(node) {
            var path = [];
            while (node !== null) {
                path.push(node.name);
                node = node.parent;
            }
            path.reverse();
            return path;
        }

        function populateDropdowns() {
            var startSelect = document.getElementById('startNode');
            var goalSelect = document.getElementById('goalNode');

            // Set untuk menyimpan nama-nama rute yang sudah ditambahkan
            var addedRoutes = new Set();

            // Iterate through each route in the JSON data
            dataGraph.routes.forEach(route => {
                if (!addedRoutes.has(route.id)) {
                    // Create an option element for the dropdown
                    var option = document.createElement('option');
                    option.value = route.id;
                    option.textContent = route.name;

                    // Add the option to the start dropdown
                    startSelect.appendChild(option);

                    // Add the route ID to the set of added routes
                    addedRoutes.add(route.id);
                }
            });
        }

        function addNodeMarkers() {
            dataGraph.routes.forEach(route => {
                var latLng = [route.lat, route.lng];
                var marker = L.marker(latLng).addTo(map);
                marker.bindPopup(route.name);
            });
        }

        function addEventListeners() {
            var startSelect = document.getElementById('startNode');
            startSelect.addEventListener('change', filterGoalNodeOptions);
        }

        function filterGoalNodeOptions() {
            var startSelect = document.getElementById('startNode');
            var goalSelect = document.getElementById('goalNode');

            // Clear current options in the goalNode dropdown
            goalSelect.innerHTML = '';

            // Get the selected startNode
            var selectedStartNodeId = startSelect.value;
            var selectedStartNode = dataGraph.routes.find(route => route.id === selectedStartNodeId);

            if (selectedStartNode) {
                var startKoridor = selectedStartNode.koridor;

                // Filter routes that share at least one koridor with the selected startNode
                dataGraph.routes.forEach(route => {
                    var hasCommonKoridor = route.koridor.some(k => startKoridor.includes(k));
                    if (hasCommonKoridor && route.id !== selectedStartNodeId) {
                        var option = document.createElement('option');
                        option.value = route.id;
                        option.textContent = route.name;
                        goalSelect.appendChild(option);
                    }
                });
            }
        }

        const koridorColors = {
            'K1': 'red',
            'K2': 'blue',
            'K3': 'green',
            'K4': 'purple',
            'K5': 'black',
            'K6': 'magenta',
        };

        var pathLayer = null;

        // Function to visualize the shortest path
        function visualizeShortestPaths(path) {
            if (path === null || path.length === 0) {
                console.log("Path does not exist or is empty!");
                if (pathLayer !== null) {
                    map.removeLayer(pathLayer); // Remove the current path layer if it exists
                }
                return;
            }

            if (pathLayer !== null) {
                map.removeLayer(pathLayer); // Remove the current path layer if it exists
            }

            var routeDetails = []; // Array to store route details for the sidebar
            var segments = []; // Array to store the segments of the path with their respective colors

            for (let i = 0; i < path.length - 1; i++) {
                var startNodeId = path[i];
                var endNodeId = path[i + 1];

                var startNode = dataGraph.routes.find(route => route.id === startNodeId);
                var endNode = dataGraph.routes.find(route => route.id === endNodeId);

                if (startNode && endNode) {
                    var latLngs = [[startNode.lat, startNode.lng], [endNode.lat, endNode.lng]];

                    // Determine the color based on the corridor transition
                    var startCorridor = startNode.koridor[0];
                    var endCorridor = endNode.koridor[0];
                    var color;

                    if (startCorridor === endCorridor) {
                        color = koridorColors[startCorridor] || 'black'; // Same corridor
                    } else {
                        color = koridorColors[endCorridor] || 'black'; // Transition to new corridor
                    }

                    segments.push({ latLngs: latLngs, color: color });

                    routeDetails.push({ id: startNode.id, name: startNode.name, koridor: startNode.koridor.join(", ") });
                    routeDetails.push({ id: endNode.id, name: endNode.name, koridor: endNode.koridor.join(", ") });
                }
            }

            // Draw each segment with the appropriate color
            pathLayer = L.layerGroup(segments.map(segment => L.polyline(segment.latLngs, { color: segment.color })));

            // Add the layer group to the map
            pathLayer.addTo(map);

            map.fitBounds(L.polyline(segments.flatMap(segment => segment.latLngs)).getBounds()); // Fit map to bounds of the path


            // Update Rute Terpendek in the sidebar
            var nodeInfoDiv = document.getElementById('nodeInfo');
            nodeInfoDiv.innerHTML = '<strong>Rute Terpendek:</strong>';

            routeDetails.forEach((route, index) => {
                var routeLabel = document.createElement('div');
                routeLabel.textContent = `ID: ${route.id}, Name: ${route.name}, Koridor: ${route.koridor}`;
                nodeInfoDiv.appendChild(routeLabel);
            });
        }

        // Function to update map with selected start and goal nodes
        function findPath() {
            var startNode = document.getElementById('startNode').value;
            var goalNode = document.getElementById('goalNode').value;
            console.log(startNode, goalNode);

            if (startNode === goalNode) {
                alert("Start node and goal node cannot be the same!");
                return;
            }

            if (pathLayer !== null) {
                map.removeLayer(pathLayer); // Remove the current path layer if it exists
            }

            var path = sma_star(startNode, goalNode);
            console.log(path);
            if (path !== null) {
                console.log("Path found:", path);
                visualizeShortestPaths(path);
            } else {
                alert("Path not found!");
                console.log("Path does not exist!");
                if (pathLayer !== null) {
                    map.removeLayer(pathLayer); // Remove the current path layer if it exists
                }
            }
        }
    </script>
</body>

</html>